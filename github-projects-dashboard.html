<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Projects Dashboard // Advanced Marketing</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --neon-cyan: #00f3ff;
            --neon-pink: #ff00ff;
            --neon-purple: #9d00ff;
            --neon-green: #00ff41;
            --neon-yellow: #ffee00;
            --neon-red: #ff0040;
            --dark-bg: #050508;
            --panel-bg: rgba(10, 10, 20, 0.95);
        }
        body {
            font-family: 'Share Tech Mono', monospace;
            background: var(--dark-bg);
            color: #e0e0e0;
            min-height: 100vh;
            overflow-x: hidden;
            background-image: 
                linear-gradient(rgba(0, 243, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 243, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
        }
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(transparent 50%, rgba(0, 243, 255, 0.02) 50%);
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 9999;
            animation: scanline 10s linear infinite;
        }
        @keyframes scanline {
            0% { transform: translateY(0); }
            100% { transform: translateY(10px); }
        }
        .header {
            text-align: center;
            padding: 30px;
            border-bottom: 2px solid var(--neon-cyan);
            box-shadow: 0 0 30px rgba(0, 243, 255, 0.3);
            background: linear-gradient(180deg, rgba(0,243,255,0.1) 0%, transparent 100%);
            position: relative;
            overflow: hidden;
        }
        .glitch {
            font-family: 'Orbitron', sans-serif;
            font-size: 3em;
            font-weight: 900;
            color: var(--neon-cyan);
            text-shadow: 0 0 10px var(--neon-cyan), 0 0 20px var(--neon-cyan), 0 0 40px var(--neon-cyan);
            position: relative;
            animation: glitch 2s infinite;
        }
        @keyframes glitch {
            0%, 100% { text-shadow: 2px 0 var(--neon-pink), -2px 0 var(--neon-cyan); }
            25% { text-shadow: -2px 0 var(--neon-pink), 2px 0 var(--neon-cyan); }
            50% { text-shadow: 2px 0 var(--neon-cyan), -2px 0 var(--neon-pink); }
            75% { text-shadow: -2px 0 var(--neon-cyan), 2px 0 var(--neon-pink); }
        }
        .subtitle {
            font-size: 1.2em;
            color: var(--neon-purple);
            margin-top: 10px;
            text-transform: uppercase;
            letter-spacing: 3px;
        }
        .stats-bar {
            display: flex;
            justify-content: center;
            gap: 30px;
            padding: 20px;
            background: var(--panel-bg);
            border-bottom: 1px solid var(--neon-cyan);
            flex-wrap: wrap;
        }
        .stat-box {
            text-align: center;
            padding: 15px 25px;
            border: 1px solid;
            border-radius: 5px;
            min-width: 120px;
        }
        .stat-box.green { border-color: var(--neon-green); color: var(--neon-green); }
        .stat-box.yellow { border-color: var(--neon-yellow); color: var(--neon-yellow); }
        .stat-box.red { border-color: var(--neon-red); color: var(--neon-red); }
        .stat-box.white { border-color: #888; color: #888; }
        .stat-box.total { border-color: var(--neon-cyan); color: var(--neon-cyan); }
        .stat-number { font-size: 2em; font-weight: bold; }
        .stat-label { font-size: 0.8em; text-transform: uppercase; margin-top: 5px; }
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            padding: 20px;
            background: var(--panel-bg);
            border-bottom: 1px solid var(--neon-cyan);
            flex-wrap: wrap;
        }
        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        input, select, button {
            background: rgba(0, 243, 255, 0.1);
            border: 1px solid var(--neon-cyan);
            color: var(--neon-cyan);
            padding: 10px 15px;
            font-family: 'Share Tech Mono', monospace;
            font-size: 14px;
            border-radius: 3px;
            outline: none;
        }
        input:focus, select:focus { box-shadow: 0 0 15px rgba(0, 243, 255, 0.5); }
        button {
            cursor: pointer;
            text-transform: uppercase;
            transition: all 0.3s;
        }
        button:hover:not(:disabled) {
            background: var(--neon-cyan);
            color: var(--dark-bg);
            box-shadow: 0 0 20px var(--neon-cyan);
        }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .refresh-timer { color: var(--neon-purple); font-size: 0.9em; }
        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(450px, 1fr));
            gap: 20px;
            padding: 20px;
            max-width: 1800px;
            margin: 0 auto;
        }
        .project-card {
            background: var(--panel-bg);
            border: 2px solid;
            border-radius: 10px;
            padding: 20px;
            position: relative;
            transition: all 0.3s;
            overflow: hidden;
        }
        .project-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; height: 3px;
            background: linear-gradient(90deg, transparent, currentColor, transparent);
        }
        .project-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .project-card.green { border-color: var(--neon-green); color: var(--neon-green); }
        .project-card.yellow { border-color: var(--neon-yellow); color: var(--neon-yellow); }
        .project-card.red { border-color: var(--neon-red); color: var(--neon-red); }
        .project-card.white { border-color: #666; color: #888; }
        .project-card .content { color: #e0e0e0; }
        .status-indicator {
            position: absolute;
            top: 15px; right: 15px;
            width: 20px; height: 20px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        .status-indicator.green { background: var(--neon-green); box-shadow: 0 0 10px var(--neon-green); }
        .status-indicator.yellow { background: var(--neon-yellow); box-shadow: 0 0 10px var(--neon-yellow); }
        .status-indicator.red { background: var(--neon-red); box-shadow: 0 0 10px var(--neon-red); }
        .status-indicator.white { background: #666; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .project-name {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.3em;
            margin-bottom: 15px;
            padding-right: 40px;
        }
        .project-detail {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 8px 0;
            font-size: 0.9em;
        }
        .detail-label { color: #888; min-width: 120px; }
        .detail-value { color: #fff; }
        .detail-value a { color: var(--neon-cyan); text-decoration: none; }
        .detail-value a:hover { text-decoration: underline; }
        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 0.8em;
            text-transform: uppercase;
        }
        .status-badge.online { background: rgba(0, 255, 65, 0.2); color: var(--neon-green); }
        .status-badge.offline { background: rgba(255, 0, 64, 0.2); color: var(--neon-red); }
        .status-badge.warning { background: rgba(255, 238, 0, 0.2); color: var(--neon-yellow); }
        .status-badge.unknown { background: rgba(136, 136, 136, 0.2); color: #888; }
        .agent-active { color: var(--neon-green); }
        .agent-inactive { color: #666; }
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.5em;
            color: var(--neon-cyan);
        }
        .loading::after {
            content: '';
            animation: dots 1.5s infinite;
        }
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
        .error-message {
            text-align: center;
            padding: 30px;
            color: var(--neon-red);
            border: 1px solid var(--neon-red);
            margin: 20px;
            border-radius: 5px;
        }
        .legend {
            display: flex;
            justify-content: center;
            gap: 30px;
            padding: 15px;
            background: var(--panel-bg);
            border-top: 1px solid var(--neon-cyan);
            font-size: 0.85em;
            flex-wrap: wrap;
        }
        .legend-item { display: flex; align-items: center; gap: 8px; }
        .legend-dot { width: 12px; height: 12px; border-radius: 50%; }
        .legend-dot.green { background: var(--neon-green); }
        .legend-dot.yellow { background: var(--neon-yellow); }
        .legend-dot.red { background: var(--neon-red); }
        .legend-dot.white { background: #666; }
        .export-btn {
            background: rgba(157, 0, 255, 0.2);
            border-color: var(--neon-purple);
            color: var(--neon-purple);
        }
        .export-btn:hover:not(:disabled) {
            background: var(--neon-purple);
            color: #fff;
        }
        .load-more-container {
            text-align: center;
            padding: 40px;
            grid-column: 1 / -1;
        }
        .load-more-btn {
            padding: 15px 40px;
            font-size: 1.1em;
            background: rgba(0, 243, 255, 0.2);
        }
        .load-more-btn:hover:not(:disabled) { background: var(--neon-cyan); }
        .all-loaded-message {
            text-align: center;
            padding: 30px;
            color: var(--neon-green);
            font-size: 1.1em;
            grid-column: 1 / -1;
        }
        .spinner {
            display: inline-block;
            width: 20px; height: 20px;
            border: 2px solid var(--neon-cyan);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .api-status {
            position: fixed;
            bottom: 20px; right: 20px;
            padding: 10px 15px;
            background: var(--panel-bg);
            border: 1px solid var(--neon-cyan);
            border-radius: 5px;
            font-size: 0.8em;
            z-index: 1000;
        }
        .api-status.success { border-color: var(--neon-green); color: var(--neon-green); }
        .api-status.error { border-color: var(--neon-red); color: var(--neon-red); }
        .api-status.loading { border-color: var(--neon-yellow); color: var(--neon-yellow); }
        @media (max-width: 768px) {
            .glitch { font-size: 2em; }
            .projects-grid { grid-template-columns: 1fr; }
            .stats-bar, .controls { flex-direction: column; align-items: center; }
        }
    </style>
</head>
<body>
    <header class="header">
        <h1 class="glitch">GITHUB PROJECTS DASHBOARD</h1>
        <p class="subtitle">Advanced Marketing // All Repositories</p>
    </header>
    
    <div class="stats-bar">
        <div class="stat-box total">
            <div class="stat-number" id="total-count">0</div>
            <div class="stat-label">Total Projects</div>
        </div>
        <div class="stat-box green">
            <div class="stat-number" id="green-count">0</div>
            <div class="stat-label">Online</div>
        </div>
        <div class="stat-box yellow">
            <div class="stat-number" id="yellow-count">0</div>
            <div class="stat-label">Warning</div>
        </div>
        <div class="stat-box red">
            <div class="stat-number" id="red-count">0</div>
            <div class="stat-label">Critical</div>
        </div>
        <div class="stat-box white">
            <div class="stat-number" id="white-count">0</div>
            <div class="stat-label">Unknown</div>
        </div>
    </div>
    
    <div class="controls">
        <div class="control-group">
            <label>Search:</label>
            <input type="text" id="search-input" placeholder="Project name..." />
        </div>
        <div class="control-group">
            <label>Filter:</label>
            <select id="filter-select">
                <option value="all">All Status</option>
                <option value="green">Online</option>
                <option value="yellow">Warning</option>
                <option value="red">Critical</option>
                <option value="white">Unknown</option>
            </select>
        </div>
        <div class="control-group">
            <label>Sort:</label>
            <select id="sort-select">
                <option value="name">Name</option>
                <option value="status">Status</option>
                <option value="updated">Last Updated</option>
                <option value="pushed">Last Pushed</option>
            </select>
        </div>
        <button onclick="refreshData()">Refresh Now</button>
        <button class="export-btn" onclick="exportReport()">Export CSV</button>
        <span class="refresh-timer">Cache expires in <span id="timer">5:00</span></span>
    </div>
    
    <div id="projects-container" class="projects-grid">
        <div class="loading">Loading repositories</div>
    </div>
    
    <div class="legend">
        <div class="legend-item">
            <div class="legend-dot green"></div>
            <span>Green - Working properly, all systems go</span>
        </div>
        <div class="legend-item">
            <div class="legend-dot yellow"></div>
            <span>Yellow - Minor issues, partially working</span>
        </div>
        <div class="legend-item">
            <div class="legend-dot red"></div>
            <span>Red - Critical issues, down or unreachable</span>
        </div>
        <div class="legend-item">
            <div class="legend-dot white"></div>
            <span>White - Unknown status or not deployed</span>
        </div>
    </div>

    <div id="api-status" class="api-status loading">Loading GitHub API...</div>

    <script>
        const CONFIG = {
            githubUsername: 'bensblueprints',
            perPage: 100,
            initialLoad: 20,
            loadMoreCount: 20,
            cacheDuration: 5 * 60 * 1000,
            statusCheckDelay: 100,
            statusCheckConcurrency: 3,
            agents: [
                { id: 'webdev-pm', name: 'PM Agent' },
                { id: 'webdev-dev', name: 'Dev Agent' },
                { id: 'webdev-qa', name: 'QA Agent' },
                { id: 'webdev-docs', name: 'Docs Agent' },
                { id: 'marketing', name: 'Marketing Agent' },
                { id: 'sales', name: 'Sales Agent' },
                { id: 'ops', name: 'Ops Agent' }
            ]
        };
        
        let allRepos = [];
        let displayedRepos = [];
        let filteredRepos = [];
        let currentOffset = 0;
        let isLoading = false;
        let cacheTimestamp = null;
        let statusCheckInterval = null;
        let cacheTimerInterval = null;
        
        function getCache() {
            try {
                const cached = localStorage.getItem('githubDashboardCache');
                const timestamp = localStorage.getItem('githubDashboardCacheTime');
                if (cached && timestamp) {
                    const age = Date.now() - parseInt(timestamp);
                    if (age < CONFIG.cacheDuration) {
                        cacheTimestamp = parseInt(timestamp);
                        return JSON.parse(cached);
                    }
                }
            } catch (e) {
                console.warn('Cache read error:', e);
            }
            return null;
        }
        
        function setCache(data) {
            try {
                localStorage.setItem('githubDashboardCache', JSON.stringify(data));
                localStorage.setItem('githubDashboardCacheTime', Date.now().toString());
                cacheTimestamp = Date.now();
            } catch (e) {
                console.warn('Cache write error:', e);
            }
        }
        
        function clearCache() {
            try {
                localStorage.removeItem('githubDashboardCache');
                localStorage.removeItem('githubDashboardCacheTime');
                cacheTimestamp = null;
            } catch (e) {
                console.warn('Cache clear error:', e);
            }
        }
        
        function startCacheTimer() {
            if (cacheTimerInterval) clearInterval(cacheTimerInterval);
            cacheTimerInterval = setInterval(() => {
                if (!cacheTimestamp) {
                    document.getElementById('timer').textContent = '5:00';
                    return;
                }
                const elapsed = Date.now() - cacheTimestamp;
                const remaining = Math.max(0, CONFIG.cacheDuration - elapsed);
                const minutes = Math.floor(remaining / 60000);
                const seconds = Math.floor((remaining % 60000) / 1000);
                document.getElementById('timer').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                if (remaining === 0) clearCache();
            }, 1000);
        }
        
        async function fetchGitHubRepos() {
            updateApiStatus('loading', 'Fetching from GitHub...');
            const repos = [];
            let page = 1;
            let hasMore = true;
            const headers = { 'Accept': 'application/vnd.github.v3+json' };
            
            while (hasMore) {
                try {
                    const url = `https://api.github.com/users/${CONFIG.githubUsername}/repos?per_page=${CONFIG.perPage}&page=${page}&sort=updated&direction=desc`;
                    const response = await fetch(url, { headers });
                    
                    if (!response.ok) {
                        if (response.status === 403) {
                            throw new Error('GitHub API rate limit exceeded. Please try again later.');
                        }
                        if (response.status === 404) {
                            throw new Error(`User '${CONFIG.githubUsername}' not found.`);
                        }
                        throw new Error(`GitHub API error: ${response.status}`);
                    }
                    
                    const pageRepos = await response.json();
                    if (pageRepos.length === 0) {
                        hasMore = false;
                    } else {
                        repos.push(...pageRepos);
                        updateApiStatus('loading', `Fetched ${repos.length} repos...`);
                        if (pageRepos.length < CONFIG.perPage) {
                            hasMore = false;
                        } else {
                            page++;
                        }
                    }
                    if (hasMore) await new Promise(r => setTimeout(r, 100));
                } catch (error) {
                    updateApiStatus('error', error.message);
                    throw error;
                }
            }
            
            updateApiStatus('success', `Loaded ${repos.length} repositories`);
            return repos;
        }
        
        function transformRepo(githubRepo) {
            let deployment = 'Unknown';
            let subdomain = null;
            
            if (githubRepo.homepage) {
                deployment = githubRepo.homepage;
                try {
                    const url = new URL(githubRepo.homepage);
                    subdomain = url.hostname;
                } catch (e) {
                    subdomain = githubRepo.homepage;
                }
            } else if (githubRepo.has_pages) {
                deployment = 'GitHub Pages';
                subdomain = `${CONFIG.githubUsername}.github.io/${githubRepo.name}`;
            }
            
            return {
                id: githubRepo.id,
                name: githubRepo.name,
                fullName: githubRepo.full_name,
                description: githubRepo.description,
                repo: githubRepo.html_url,
                deployment: deployment,
                subdomain: subdomain,
                private: githubRepo.private,
                stars: githubRepo.stargazers_count,
                forks: githubRepo.forks_count,
                openIssues: githubRepo.open_issues_count,
                language: githubRepo.language,
                createdAt: githubRepo.created_at,
                updatedAt: githubRepo.updated_at,
                pushedAt: githubRepo.pushed_at,
                hasPages: githubRepo.has_pages,
                hasDatabase: githubRepo.name.toLowerCase().includes('db') || 
                            githubRepo.name.toLowerCase().includes('api') ||
                            githubRepo.name.toLowerCase().includes('backend'),
                hasFiles: true,
                topics: githubRepo.topics || [],
                status: 'white',
                checks: {
                    site: { status: 'unknown', code: 0 },
                    dns: 'unknown',
                    database: 'unknown',
                    files: 'unknown'
                },
                activeAgent: checkAgentActivity(githubRepo.name),
                checkedAt: null
            };
        }
        
        function checkAgentActivity(repoName) {
            const agentAssignments = {
                'advancedmarketing.co': 'webdev-dev',
                'claws-dashboard': 'webdev-pm',
                'dashboard-github': 'webdev-pm',
                'agent-system': 'ops',
                'meta-pixel-manager': 'marketing',
                'email-automation': 'webdev-dev',
                'landing-page-builder': 'marketing',
                'analytics-dashboard': 'webdev-dev',
                'api-gateway': 'webdev-dev',
                'chatbot-service': 'webdev-qa',
                'leadforge': 'marketing',
                'lead-scraper': 'sales',
                'social-automation': 'marketing',
                'upwork-scraper': 'sales',
                'web-design-landing': 'webdev-dev',
                'webdev-agent': 'webdev-pm',
                'docs': 'webdev-docs',
                'documentation': 'webdev-docs'
            };
            if (agentAssignments[repoName]) return agentAssignments[repoName];
            for (const [key, agent] of Object.entries(agentAssignments)) {
                if (repoName.toLowerCase().includes(key.toLowerCase())) return agent;
            }
            return null;
        }
        
        async function checkSiteStatus(url) {
            if (!url || url === 'Unknown') return { status: 'unknown', code: 0 };
            try {
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), 5000);
                const response = await fetch(url, { 
                    method: 'HEAD',
                    mode: 'no-cors',
                    signal: controller.signal
                });
                clearTimeout(timeout);
                return { status: 'online', code: 200 };
            } catch (e) {
                return { status: 'offline', code: 0, error: e.message };
            }
        }
        
        function determineStatus(repo, checks) {
            if (!repo.subdomain || repo.deployment === 'Unknown') return 'white';
            if (checks.site.status === 'offline') return 'red';
            if (checks.site.status === 'online') return 'green';
            return 'white';
        }
        
        async function checkRepoStatus(repo) {
            const checks = {
                site: await checkSiteStatus(repo.subdomain ? `https://${repo.subdomain}` : null),
                dns: repo.subdomain ? 'active' : 'unknown',
                database: repo.hasDatabase ? 'unknown' : 'none',
                files: 'accessible'
            };
            const status = determineStatus(repo, checks);
            return { ...repo, status, checks, checkedAt: new Date().toISOString() };
        }
        
        function startLazyStatusChecking() {
            if (statusCheckInterval) clearInterval(statusCheckInterval);
            let index = 0;
            const reposToCheck = [...allRepos];
            statusCheckInterval = setInterval(async () => {
                if (index >= reposToCheck.length) {
                    clearInterval(statusCheckInterval);
                    return;
                }
                const batch = reposToCheck.slice(index, index + CONFIG.statusCheckConcurrency);
                const checkPromises = batch.map(async (repo) => {
                    const updatedRepo = await checkRepoStatus(repo);
                    const repoIndex = allRepos.findIndex(r => r.id === repo.id);
                    if (repoIndex !== -1) allRepos[repoIndex] = updatedRepo;
                    const displayedIndex = displayedRepos.findIndex(r => r.id === repo.id);
                    if (displayedIndex !== -1) {
                        displayedRepos[displayedIndex] = updatedRepo;
                        updateRepoCard(updatedRepo);
                    }
                });
                await Promise.all(checkPromises);
                index += CONFIG.statusCheckConcurrency;
                if (index % 10 === 0) updateStats(allRepos);
            }, CONFIG.statusCheckDelay);
        }
        
        function updateRepoCard(repo) {
            const card = document.querySelector(`[data-repo-id="${repo.id}"]`);
            if (card) {
                card.className = `project-card ${repo.status}`;
                const indicator = card.querySelector('.status-indicator');
                if (indicator) indicator.className = `status-indicator ${repo.status}`;
            }
        }
        
        function filterAndSortRepos() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase().trim();
            const filterStatus = document.getElementById('filter-select').value;
            const sortBy = document.getElementById('sort-select').value;
            
            filteredRepos = allRepos.filter(repo => {
                const matchesSearch = !searchTerm || 
                    repo.name.toLowerCase().includes(searchTerm) ||
                    (repo.description && repo.description.toLowerCase().includes(searchTerm)) ||
                    (repo.language && repo.language.toLowerCase().includes(searchTerm));
                const matchesFilter = filterStatus === 'all' || repo.status === filterStatus;
                return matchesSearch && matchesFilter;
            });
            
            filteredRepos.sort((a, b) => {
                switch (sortBy) {
                    case 'name': return a.name.localeCompare(b.name);
                    case 'status':
                        const statusOrder = { green: 0, yellow: 1, red: 2, white: 3 };
                        return statusOrder[a.status] - statusOrder[b.status];
                    case 'updated': return new Date(b.updatedAt) - new Date(a.updatedAt);
                    case 'pushed': return new Date(b.pushedAt || b.updatedAt) - new Date(a.pushedAt || a.updatedAt);
                    default: return 0;
                }
            });
            return filteredRepos;
        }
        
        function formatDate(dateString) {
            if (!dateString) return 'Never';
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            if (diffDays === 0) {
                const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                if (diffHours === 0) {
                    const diffMins = Math.floor(diffMs / (1000 * 60));
                    return diffMins === 0 ? 'Just now' : `${diffMins}m ago`;
                }
                return `${diffHours}h ago`;
            }
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return `${diffDays}d ago`;
            if (diffDays < 30) return `${Math.floor(diffDays / 7)}w ago`;
            return date.toLocaleDateString();
        }
        
        function renderRepoCard(repo) {
            const agent = repo.activeAgent ? CONFIG.agents.find(a => a.id === repo.activeAgent) : null;
            return `
                <div class="project-card ${repo.status}" data-repo-id="${repo.id}">
                    <div class="status-indicator ${repo.status}"></div>
                    <div class="content">
                        <h3 class="project-name">${repo.name}</h3>
                        ${repo.description ? `<div class="project-detail"><span class="detail-value" style="color:#888;font-size:0.85em">${repo.description.substring(0, 80)}${repo.description.length > 80 ? '...' : ''}</span></div>` : ''}
                        <div class="project-detail">
                            <span class="detail-label">Repository:</span>
                            <span class="detail-value"><a href="${repo.repo}" target="_blank">${repo.fullName}</a></span>
                        </div>
                        <div class="project-detail">
                            <span class="detail-label">Language:</span>
                            <span class="detail-value">${repo.language || 'N/A'}</span>
                        </div>
                        <div class="project-detail">
                            <span class="detail-label">Deployment:</span>
                            <span class="detail-value">${repo.deployment}</span>
                        </div>
                        ${repo.subdomain ? `
                        <div class="project-detail">
                            <span class="detail-label">Site:</span>
                            <span class="detail-value"><a href="https://${repo.subdomain}" target="_blank">${repo.subdomain}</a></span>
                        </div>` : ''}
                        <div class="project-detail">
                            <span class="detail-label">Stars:</span>
                            <span class="detail-value">‚≠ê ${repo.stars} | üç¥ ${repo.forks}</span>
                        </div>
                        <div class="project-detail">
                            <span class="detail-label">Agent:</span>
                            <span class="detail-value ${agent ? 'agent-active' : 'agent-inactive'}">${agent ? agent.name : 'None'}</span>
                        </div>
                        <div class="project-detail">
                            <span class="detail-label">Updated:</span>
                            <span class="detail-value">${formatDate(repo.updatedAt)}</span>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderProjects(repos, append = false) {
            const container = document.getElementById('projects-container');
            
            if (!append) {
                container.innerHTML = '';
                displayedRepos = [];
                currentOffset = 0;
            }
            
            const reposToShow = repos.slice(currentOffset, currentOffset + CONFIG.loadMoreCount);
            displayedRepos.push(...reposToShow);
            currentOffset += reposToShow.length;
            
            const cardsHtml = reposToShow.map(renderRepoCard).join('');
            
            if (append) {
                container.insertAdjacentHTML('beforeend', cardsHtml);
            } else {
                container.innerHTML = cardsHtml;
            }
            
            renderLoadMoreButton(repos);
            updateStats(allRepos);
        }
        
        function renderLoadMoreButton(repos) {
            const container = document.getElementById('projects-container');
            const existingBtn = container.querySelector('.load-more-container, .all-loaded-message');
            if (existingBtn) existingBtn.remove();
            
            if (currentOffset >= repos.length) {
                if (repos.length > 0) {
                    container.insertAdjacentHTML('beforeend', `
                        <div class="all-loaded-message">
                            ‚úì All ${repos.length} repositories loaded
                        </div>
                    `);
                }
            } else {
                container.insertAdjacentHTML('beforeend', `
                    <div class="load-more-container">
                        <button class="load-more-btn" onclick="loadMore()" ${isLoading ? 'disabled' : ''}>
                            ${isLoading ? '<span class="spinner"></span>Loading...' : `Load More (${repos.length - currentOffset} remaining)`}
                        </button>
                    </div>
                `);
            }
        }
        
        function loadMore() {
            if (isLoading) return;
            isLoading = true;
            renderLoadMoreButton(filteredRepos);
            
            setTimeout(() => {
                isLoading = false;
                renderProjects(filteredRepos, true);
            }, 300);
        }
        
        function updateStats(repos) {
            const counts = {
                total: repos.length,
                green: repos.filter(p => p.status === 'green').length,
                yellow: repos.filter(p => p.status === 'yellow').length,
                red: repos.filter(p => p.status === 'red').length,
                white: repos.filter(p => p.status === 'white').length
            };
            
            document.getElementById('total-count').textContent = counts.total;
            document.getElementById('green-count').textContent = counts.green;
            document.getElementById('yellow-count').textContent = counts.yellow;
            document.getElementById('red-count').textContent = counts.red;
            document.getElementById('white-count').textContent = counts.white;
        }
        
        function updateApiStatus(type, message) {
            const el = document.getElementById('api-status');
            el.className = `api-status ${type}`;
            el.textContent = message;
        }
        
        async function refreshData() {
            clearCache();
            await loadData();
        }
        
        async function loadData() {
            isLoading = true;
            
            try {
                const cached = getCache();
                
                if (cached) {
                    allRepos = cached;
                    updateApiStatus('success', `Loaded ${allRepos.length} repos from cache`);
                } else {
                    const githubRepos = await fetchGitHubRepos();
                    allRepos = githubRepos.map(transformRepo);
                    setCache(allRepos);
                }
                
                filteredRepos = filterAndSortRepos();
                renderProjects(filteredRepos, false);
                startCacheTimer();
                startLazyStatusChecking();
                
            } catch (error) {
                document.getElementById('projects-container').innerHTML = `
                    <div class="error-message">
                        Error: ${error.message}<br>
                        <button onclick="refreshData()" style="margin-top:15px">Try Again</button>
                    </div>
                `;
            } finally {
                isLoading = false;
            }
        }
        
        function exportReport() {
            const headers = ['Name', 'Full Name', 'Description', 'Repository', 'Status', 'Language', 'Stars', 'Forks', 'Open Issues', 'Deployment', 'Subdomain', 'Agent', 'Created At', 'Updated At', 'Pushed At'];
            const rows = allRepos.map(p => [
                p.name,
                p.fullName,
                p.description || '',
                p.repo,
                p.status,
                p.language || '',
                p.stars,
                p.forks,
                p.openIssues,
                p.deployment,
                p.subdomain || '',
                p.activeAgent || 'None',
                p.createdAt,
                p.updatedAt,
                p.pushedAt || ''
            ]);
            
            const csv = [headers.join(','), ...rows.map(r => r.map(v => `"${String(v).replace(/"/g, '""')}"`).join(','))].join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `github-projects-report-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // Event listeners
        document.getElementById('search-input').addEventListener('input', () => {
            filteredRepos = filterAndSortRepos();
            renderProjects(filteredRepos, false);
        });
        
        document.getElementById('filter-select').addEventListener('change', () => {
            filteredRepos = filterAndSortRepos();
            renderProjects(filteredRepos, false);
        });
        
        document.getElementById('sort-select').addEventListener('change', () => {
            filteredRepos = filterAndSortRepos();
            renderProjects(filteredRepos, false);
        });
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
        });
    </script>
</body>
</html>
